name: Erlang CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: 28

      - name: Install rebar3
        run: |
          wget https://s3.amazonaws.com/rebar3/rebar3
          chmod +x rebar3
          sudo mv rebar3 /usr/local/bin/
          rebar3 --version

      - name: Install erlfmt
        run: |
        wget https://github.com/WhatsApp/erlfmt/releases/download/v0.11.0/erlfmt-0.11.0-linux-amd64 -O erlfmt
        chmod +x erlfmt
        sudo mv erlfmt /usr/local/bin/
        erlfmt --version

      - name: Format code
        run: |
          erlfmt src test

      - name: Compile project
        run: |
          rebar3 compile

     
      - name: Run lint
        run: |
          rebar3 lint

      - name: Run EUnit tests
        run: |
          rebar3 eunit

      - name: Check for unwanted files
        run: |
          git ls-files --exclude-standard --others --ignored --directory
          # Этот шаг покажет, что нет лишних файлов, можно CI падать при наличии
